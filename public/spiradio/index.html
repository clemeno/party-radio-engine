<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    >
    <title>SpiRadio</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700,400italic|Material+Icons"
    >
    <link
      rel="stylesheet"
      href="https://unpkg.com/vue-material/dist/vue-material.min.css"
    >
    <link
      rel="stylesheet"
      href="https://unpkg.com/vue-material/dist/theme/default.css"
    >
    <style>
      .submissions {
        font-family: monospace;
      }

    </style>
  </head>

  <body>

    <div id="app">

      <h1>SpiRadio</h1>

      <div>
        <h2>Now Playing</h2>
        <div>
          <h3>Radio</h3>
          <md-button class="md-icon-button md-dense md-primary">
            <md-icon>play_arrow</md-icon>
          </md-button>
        </div>
        <div>{{ radio.currentTitleDisplay }}</div>
        <div>
          <h3>Perso</h3>
          <md-button class="md-icon-button md-dense md-primary">
            <md-icon>play_arrow</md-icon>
          </md-button>
        </div>
        <div>{{ perso.currentTitleDisplay }}</div>
      </div>

      <div>
        <h2>Flux</h2>
      </div>

      <div>
        <h2>Player</h2>
        <div>
          <div>
            <md-button class="md-icon-button md-dense md-primary">
              <md-icon>skip_previous</md-icon>
            </md-button>
            <md-button class="md-icon-button md-dense md-primary">
              <md-icon>play_arrow</md-icon>
            </md-button>
            <md-button class="md-icon-button md-dense md-primary">
              <md-icon>pause</md-icon>
            </md-button>
            <md-button class="md-icon-button md-dense md-primary">
              <md-icon>stop</md-icon>
            </md-button>
            <md-button class="md-icon-button md-dense md-primary">
              <md-icon>skip_next</md-icon>
            </md-button>
          </div>
          <div>
            <md-button class="md-icon-button md-dense md-primary">
              <md-icon>volume_up</md-icon>
            </md-button>
            <md-button class="md-icon-button md-dense md-primary">
              <md-icon>volume_off</md-icon>
            </md-button>
          </div>
        </div>
      </div>

      <div>
        <h2>Online ({{ online.userList.length }})</h2>
      </div>

      <div class="submissions">
        <h2>Submit as {{ uuid }}</h2>
        <input
          v-on:keyup.enter="sendUrl"
          v-model="share.url"
          type="text"
          placeholder="Enter a new URL to share"
        >
        <ol>
          <li v-for="( item, index ) in share.urlList">{{ item.isoTime }} | {{ item.senderUuid }} | {{ item.urlText }}</li>
        </ol>
      </div>

    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.2.0/uuidv4.min.js"></script>

    <script src="https://unpkg.com/vue"></script>
    <script src="https://unpkg.com/vue-material"></script>
    <script>Vue.use( VueMaterial.default )</script>
    <script>
      Vue.material = {
        ...Vue.material,

        // activeness of ripple effect
        ripple: true,

        theming: {},
        locale: {
          ...Vue.material.locale,

          // range for datepicker
          startYear: 1900,
          endYear: 2099,

          // date format for date picker
          dateFormat: 'yyyy-MM-dd',

          // `0` stand for Sunday, `1` stand for Monday
          firstDayOfAWeek: 1
        }
      }
    </script>

    <script>
      new Vue( {
        el: '#app',
        data: {
          uuid: uuidv4(),
          socket: null,
          bRadio: true,
          radio: {
            currentTitleDisplay: ''
          },
          perso: {
            currentTitleDisplay: ''
          },
          flux: {

          },
          player: {

          },
          online: {
            userList: []
          },
          share: {
            urlList: [],
            url: ''
          }
        },
        created: function() {
          this.socket = io()

          this.socket.on( 'USERS_LIST_UPDATED', ( { userList } ) => {
            this.online.userList = userList
          } )

          this.socket.on( 'NEW_SUBMISSION_PROCESSED', ( { urlText, isoTime, senderUuid, msTimestamp } ) => {
            const item = { urlText, isoTime, senderUuid, msTimestamp }
            if ( this.share.urlList.every( entry => entry.urlText !== urlText ) ) {
              const freshUrlList = this.share.urlList.slice()

              freshUrlList.push( item )

              freshUrlList.sort( ( a, b ) => (
                ( b.msTimestamp - a.msTimestamp ) ||
                ( ( a.senderUuid < b.senderUuid ) ? -1 : +( b.senderUuid < a.senderUuid ) )
              ) )

              if ( 10000 < freshUrlList.length ) {
                freshUrlList.pop()
              }

              this.share.urlList = freshUrlList
            }
          } )

          this.socket.emit( 'HAJIMEMASHITE', { uuid: this.uuid } )
        },
        methods: {
          sendUrl: function() {
            const { url, urlList } = this.share

            const urlText = `${url || ''}`.trim()

            if ( urlText && urlList.every( entry => entry.urlText !== urlText ) ) {
              this.share.url = ''
              const item = { urlText, senderUuid: this.uuid }
              this.socket.emit( 'SUBMIT_URL', item )
            }
          }
        },
        destroyed: function() {

        }
      } )
    </script>
  </body>

</html>
